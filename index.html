<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P Chat</title>
  <style id="dynamic-style">
    body {
      font-family: sans-serif;
      background: #f8f8f8;
      color: #333;
      margin: 0;
    }

    #log {
      position: relative;
      white-space: pre-wrap;
      border-top: 1px solid #ccc;
      background: #fff;
      padding: 1rem;
      height: calc(100vh - 240px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      margin-bottom: 5rem;
    }

    #log > div {
      margin-bottom: 1rem;
      position: relative;
    }

    .menu-btn {
      position: absolute;
      left: -25px;
      top: 0;
      cursor: pointer;
      opacity: 0.3;
    }

    .menu {
      position: absolute;
      left: 0;
      top: 1.5em;
      background: #eee;
      border: 1px solid #ccc;
      font-size: 0.85em;
      display: none;
      z-index: 10;
    }

    .menu button {
      display: block;
      padding: 0.3em 0.5em;
      width: 100%;
      border: none;
      background: none;
      cursor: pointer;
    }

    .reply-preview {
      font-size: 0.85em;
      color: #555;
      margin-bottom: 0.3em;
    }

    .send {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      z-index: 10;
    }

    .reply-box {
      position: fixed;
      bottom: 100px;
      left: 0;
      width: 100%;
      padding: 0 1rem;
      font-size: 0.9em;
      color: #555;
    }

    img {
      max-width: 150px;
      display: block;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h2>P2P Chat (PeerJS)</h2>

  <div class="co">
    <button id="create">Créer une connexion</button>
    <p>Ton ID : <span id="my-id">-</span></p>
  </div>

  <div class="join">
    <input id="peer-id" placeholder="ID " />
    <button id="connect">Join</button>
  </div>

  <div class="reply-box" id="reply-box" style="display:none;">
    Répondre à : <span id="reply-preview"></span> <button onclick="cancelReply()">Annuler</button>
  </div>

  <div class="send">
    <input type="file" id="imgInput" />
    <input id="message" placeholder="Message..." />
    <button id="send">Envoyer</button>
  </div>

  <div>
    <button id="toggle-css-editor">Modifier le CSS</button>
    <textarea id="css-editor" style="display:none;width:100%;height:150px;margin-top:1rem;"></textarea>
  </div>

  <pre id="log"></pre>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const myIdDisplay = document.getElementById('my-id');
    const log = document.getElementById('log');
    const messageInput = document.getElementById('message');
    const cssEditor = document.getElementById('css-editor');
    const styleTag = document.getElementById('dynamic-style');
    const replyBox = document.getElementById("reply-box");
    const replyPreview = document.getElementById("reply-preview");
    const username = prompt("Username ?");
    
    let replyTo = null;
    const connections = [];
    const userNames = new Map();
    const MAX_CLIENTS = 5;
    let peer = null;

    const formatMessage = (text) => {
      return text.replace(/\[(#?[a-zA-Z0-9]+):([^\]]+)\]/g, (_, color, content) => {
        return `<span style="color:${color}">${content}</span>`;
      });
    };

    const logMessage = (html, meta = {}) => {
      const div = document.createElement('div');
      const menuBtn = document.createElement("span");
      menuBtn.textContent = "⋮";
      menuBtn.className = "menu-btn";
      const menu = document.createElement("div");
      menu.className = "menu";

      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Répondre";
      replyBtn.onclick = () => {
        replyTo = meta;
        replyPreview.textContent = `${meta.name || "?"} - "${meta.text}"`;
        replyBox.style.display = "block";
        menu.style.display = "none";
      };

      menu.appendChild(replyBtn);
      menuBtn.onclick = () => {
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      };

      div.appendChild(menuBtn);
      div.appendChild(menu);
      div.innerHTML += html;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    };

    window.cancelReply = () => {
      replyTo = null;
      replyBox.style.display = "none";
      replyPreview.textContent = "";
    };

    document.getElementById('toggle-css-editor').onclick = () => {
      cssEditor.style.display = cssEditor.style.display === 'none' ? 'block' : 'none';
      cssEditor.value = styleTag.textContent;
    };

    cssEditor.addEventListener('input', () => {
      styleTag.textContent = cssEditor.value;
    });

    document.getElementById('create').onclick = () => {
      peer = new Peer();
      peer.on('open', (id) => {
        myIdDisplay.textContent = id;
        logMessage(`<i>Ton ID: ${id}</i>`);
      });

      peer.on('connection', (connection) => {
        if (connections.length >= MAX_CLIENTS - 1) {
          connection.close();
          logMessage(`<i>Connexion refusée : max atteint.</i>`);
          return;
        }
        setupConnection(connection);
      });
    };

    document.getElementById('connect').onclick = () => {
      const peerId = document.getElementById('peer-id').value;
      if (!peer) peer = new Peer();
      peer.on('open', () => {
        const conn = peer.connect(peerId);
        setupConnection(conn);
      });
    };

    document.getElementById('send').onclick = () => {
      const msg = messageInput.value.trim();
      if (!msg) return;

      const data = {
        type: "message",
        text: msg
      };

      if (replyTo) {
        data.replyTo = {
          name: replyTo.name,
          text: replyTo.text
        };
      }

      connections.forEach(c => c.send(data));

      const replyHtml = replyTo ? `<div class="reply-preview"><i>En réponse à ${replyTo.name} : "${replyTo.text}"</i></div>` : "";
      logMessage(`${replyHtml}<b>${username}:</b> ${formatMessage(msg)}`, { name: username, text: msg });
      messageInput.value = '';
      cancelReply();
    };

    document.getElementById("imgInput").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result;
        connections.forEach(c => c.send({ type: "image", data: base64 }));
        const img = document.createElement("img");
        img.src = base64;
        log.appendChild(img);
      };
      reader.readAsDataURL(file);
    });

    function setupConnection(connection) {
      connection.on('open', () => {
        connections.push(connection);
        connection.send({ type: "username", name: username });

        connection.on('data', (data) => {
          if (data.type === "username") {
            userNames.set(connection, data.name);
            logMessage(`<i>${data.name} a rejoint la conversation</i>`);
          } else if (data.type === "message") {
            const name = userNames.get(connection) || "Inconnu";
            const replyHtml = data.replyTo ? `<div class="reply-preview"><i>En réponse à ${data.replyTo.name} : "${data.replyTo.text}"</i></div>` : "";
            logMessage(`${replyHtml}<b>${name}:</b> ${formatMessage(data.text)}`, { name, text: data.text });
          } else if (data.type === "image") {
            const img = document.createElement("img");
            img.src = data.data;
            log.appendChild(img);
          }
        });

        connection.on('close', () => {
          const name = userNames.get(connection) || "Un utilisateur";
          logMessage(`<i>${name} s'est déconnecté.</i>`);
          userNames.delete(connection);
          connections.splice(connections.indexOf(connection), 1);
        });
      });
    }
  </script>
</body>
</html>