<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P Chat</title>
  <style id="dynamic-style">
   
body {
  font-family: sans-serif;
  background: #f8f8f8;
  color: #333;
  margin: 0;
  
}

#log {
  position: relative;
  white-space: pre-wrap;
  border-top: 1px solid #ccc;
  background: #fff;
  padding: 1rem;
  height: calc(100vh - 220px);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
   margin-bottom: 5rem;
}

#log > div {
  margin-bottom: 1rem;
}

img {
  max-width: 150px;
  display: block;
  margin-top: 0.5rem;
}

/* Barre d'envoi fixée en bas */
.send {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid #ccc;
  padding: 1rem;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  z-index: 10;
}
  </style>
</head>
<body>
  <h2>P2P Chat (PeerJS)</h2>

  <div class="co">
    <button id="create">Créer une connexion</button>
    <p>Ton ID : <span id="my-id">-</span></p>
  </div>

 <div class="join">
    <input id="peer-id" placeholder="ID " />
    <button id="connect">Join</button>
  </div>

 <div class="send">
    <input type="file" id="imgInput" />
    <input id="message" placeholder="Message..." />
    <button id="send">Envoyer</button>
  </div>

  <div>
    <button id="toggle-css-editor">Modifier le CSS</button>
    <textarea id="css-editor" style="display:none;width:100%;height:150px;margin-top:1rem;"></textarea>
  </div>

  <pre id="log"></pre>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const myIdDisplay = document.getElementById('my-id');
    const log = document.getElementById('log');
    const messageInput = document.getElementById('message');
    const cssEditor = document.getElementById('css-editor');
    const styleTag = document.getElementById('dynamic-style');
    const username = prompt("Username ?");
    
    const connections = [];
    const userNames = new Map();
    const MAX_CLIENTS = 5;
    let peer = null;

    const logMessage = (html) => {
      const div = document.createElement('div');
      div.innerHTML = html;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    };

    const formatMessage = (text) => {
      return text.replace(/\[(#?[a-zA-Z0-9]+):([^\]]+)\]/g, (_, color, content) => {
        return `<span style="color:${color}">${content}</span>`;
      });
    };

    // CSS toggle
    document.getElementById('toggle-css-editor').onclick = () => {
      cssEditor.style.display = cssEditor.style.display === 'none' ? 'block' : 'none';
      cssEditor.value = styleTag.textContent;
    };

    cssEditor.addEventListener('input', () => {
      styleTag.textContent = cssEditor.value;
    });

    // Création d'une session
    document.getElementById('create').onclick = () => {
      peer = new Peer();
      peer.on('open', (id) => {
        myIdDisplay.textContent = id;
        logMessage(`<i>Ton ID: ${id}</i>`);
      });

      peer.on('connection', (connection) => {
        if (connections.length >= MAX_CLIENTS - 1) {
          connection.close();
          logMessage(`<i>Connexion refusée : max atteint.</i>`);
          return;
        }
        setupConnection(connection);
      });
    };

    // Rejoindre une session
    document.getElementById('connect').onclick = () => {
      const peerId = document.getElementById('peer-id').value;
      if (!peer) peer = new Peer();
      peer.on('open', () => {
        const conn = peer.connect(peerId);
        setupConnection(conn);
      });
    };

    // Envoi de texte
    document.getElementById('send').onclick = () => {
      const msg = messageInput.value.trim();
      if (!msg) return;
      connections.forEach(c => c.send({ type: "message", text: msg }));
      logMessage(`<b>${username}:</b> ${formatMessage(msg)}`);
      messageInput.value = '';
    };

    // Envoi d’image
    document.getElementById("imgInput").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result;
        connections.forEach(c => c.send({ type: "image", data: base64 }));
        const img = document.createElement("img");
        img.src = base64;
        log.appendChild(img);
      };
      reader.readAsDataURL(file);
    });

    function setupConnection(connection) {
      connection.on('open', () => {
        connections.push(connection);
        connection.send({ type: "username", name: username });

        connection.on('data', (data) => {
          if (data.type === "username") {
            userNames.set(connection, data.name);
            logMessage(`<i>${data.name} a rejoint la conversation</i>`);
          } else if (data.type === "message") {
            const name = userNames.get(connection) || "Inconnu";
            logMessage(`<b>${name}:</b> ${formatMessage(data.text)}`);
          } else if (data.type === "image") {
            const img = document.createElement("img");
            img.src = data.data;
            log.appendChild(img);
          }
        });

        connection.on('close', () => {
          const name = userNames.get(connection) || "Un utilisateur";
          logMessage(`<i>${name} s'est déconnecté.</i>`);
          userNames.delete(connection);
          connections.splice(connections.indexOf(connection), 1);
        });
      });
    }
  </script>
</body>
</html>